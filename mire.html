<!DOCTYPE html>
<html>
<body>

    <head>
      <title>Mirage</title>
        
        <style>
        
        </style>
    </head>

     
      Image size:
      <input type="text" id="imageWidthField" value="">
         x
      <input type="text" id="imageHeightField" value="">
         Squares :
      <input type="text" id="nbSquaresW">
          x 
      <input type="text" id="nbSquaresH">
    
    
    <canvas id="myCanvas" width="720" height="405"
    style="border:1px solid #d3d3d3;">
        Your browser does not support the canvas element.
    </canvas>
    
    <a id="downloadButton">Download Image</a>

    <script>
        //Setup
        //Settings fields
        var widthField = document.getElementById("imageWidthField");
        var imgWidth = widthField.value;
        widthField.addEventListener("input", generateMire);
        
        var heightField = document.getElementById("imageHeightField");
        var imgHeight = widthField.value;
        heightField.addEventListener("input", generateMire);
        
        var squaresWidthField = document.getElementById("nbSquaresW");
        var nbRectWidth = squaresWidthField.value;
        squaresWidthField.addEventListener("input", generateMire);
        squaresWidthField.addEventListener("keypress", squaresErgonomy);
        squaresWidthField.addEventListener("blur", function currFunction(){if(squaresWidthField.value <= 0) setSquaresFields(0)}); //Set the field to 0 if empty or not valid
        
        var squaresHeightField = document.getElementById("nbSquaresH");
        var nbRectHeight = squaresHeightField.value;
        squaresHeightField.addEventListener("input", generateMire);
        squaresHeightField.addEventListener("keypress", squaresErgonomy);
        squaresHeightField.addEventListener("blur", function currFunction(){if(squaresHeightField.value <= 0) setSquaresFields(0)}); //Set the field to 0 if empty or not valid
        
        function myFunction() {//debug function
    alert ("Hello World!");
}
        
        //Canvas
        var canvas = document.getElementById("myCanvas");
        var canvasCtx = canvas.getContext("2d");
        var img = document.createElement("canvas");
        var imgCtx = img.getContext("2d");
        

        //Settings variables
        var rectWidth;
        var rectHeight;
        var fontSize;

        
        //Internal management
        var squaresEnabled = true;
        var bckSpaceCount = 0;
        
        //Algorithm
       
        generateMire();
        
        //Setup the download button
        var link = document.getElementById("downloadButton");
        link.addEventListener('click', function(ev) {
            link.href = img.toDataURL();
            link.download = "mire_"+String(imgWidth)+"x"+String(imgHeight)+".png";
        }, false);
        
        
        //Functions
        
        function squaresErgonomy(e) {//Squares fields ergonomy
            
            if(e.key == "Backspace"){
                bckSpaceCount++;
            } else {
                bckSpaceCount = 0;
            }
            
             if(bckSpaceCount == 3 && squaresEnabled && (nbRectWidth <= 0 || nbRectHeight <= 0)){
                 setSquaresFields(0);
                 squaresEnabled = false;
             } 
             if(nbRectWidth > 0 && nbRectHeight > 0) {
                 squaresEnabled = true;
             }
            generateMire();
        }
        
        function setSquaresFields(n) {
            squaresWidthField.value = 0;
            squaresHeightField.value = 0;
        }
        
        
        
        function updateSettings() {
            imgWidth = widthField.value;
            imgHeight = heightField.value;
            img.width = imgWidth;
            img.height = imgHeight;
            nbRectWidth = squaresWidthField.value;
            nbRectHeight = squaresHeightField.value;
            rectWidth = imgWidth / nbRectWidth;
            rectHeight = imgHeight / nbRectHeight;
            fontSize = String(rectHeight > rectWidth ? rectWidth : rectHeight)+"px";
            imgCtx.font = fontSize+" Arial";
            imgCtx.textAlign = "center";
            imgCtx.textBaseline="middle";
        }
        
        
        
         function generateMire(){
             updateSettings();
             canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            for (var j = 0 ; j < nbRectWidth ; ++j) {
              for (var i = 0 ; i < nbRectHeight ; ++i) {
                  imgCtx.fillStyle = (i+j) % 2 == 0 ? "black" : "white";
                  imgCtx.fillRect(rectWidth * j, rectHeight * i, rectWidth, rectHeight);
                  imgCtx.fillStyle = (i+j) % 2 == 0 ? "blue" : "red";
                  imgCtx.fillText(1 + j, rectWidth/2 + rectWidth * j, rectHeight/2 + rectHeight * i);
              }
            }
             
            //Draw the working img in the page canvas
            canvasCtx.drawImage(img, 0, 0, img.width,    img.height,     // source rectangle
                       0, 0, canvas.width, canvas.height); // destination rectangle
             //myFunction();
        }
    </script>

</body>
</html>
