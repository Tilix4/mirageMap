<!DOCTYPE html>
<html>

<body>

    <head>
        <title>Mirage</title>

        <style>


        </style>
    </head>

    <div id="Settings">
        <div id="ImageSize">
            Image size:
            <input type="text" id="imageWidthField" value="1920"> x
            <input type="text" id="imageHeightField" value="1080">
        </div>
        <div id="GridSettings">
            Grid :
            <input type="text" id="nbSquaresW" value="10"> x
            <input type="text" id="nbSquaresH" value="10">


            <input type="checkbox" id="squaresCheckbox" checked="true"> Squares
        </div>
        <div id="LinesSettings">
            Lines :
            <input type="text" id="linesField" value="2">
            <input type="checkbox" id="crossesCheckbox" checked="true"> Crosses
        </div>
        <div id="CirclesSettings">
            Circles :
            <input type="text" id="circlesField" value="2">
            <input type="checkbox" id="fittedCirclesCheckbox" checked="true"> Fitted circles
        </div>
        <div id="GradientSettings">
            Gradient
            Start color :
            <input type="color" id="grdStartColorSelector" value="#ff0000ff">
            End color :
            <input type="color" id="grdEndColorSelector" value="#00ff00">
        </div>
    </div>

    <canvas id="myCanvas" width="720" height="405" style="border:1px solid #d3d3d3;">
        Your browser does not support the canvas element.
    </canvas>

    <div id="ExportSettings">
        <a id="downloadButton">Download Image</a>
    </div>
    <script>
        //Setup
        //Settings fields
        var widthField = document.getElementById("imageWidthField");
        var imgWidth = widthField.value;
        widthField.addEventListener("input", generateMire);

        var heightField = document.getElementById("imageHeightField");
        var imgHeight = widthField.value;
        heightField.addEventListener("input", generateMire);

        var rectWidthField = document.getElementById("nbSquaresW");
        var nbRectWidth = rectWidthField.value;
        rectWidthField.addEventListener("input", generateMire);
        rectWidthField.addEventListener("keypress", squaresErgonomy);
        rectWidthField.addEventListener("blur", function currFunction() {
            if (rectWidthField.value <= 0) setSquaresFields(0)
        }); //Set the field to 0 if empty or not valid

        var rectHeightField = document.getElementById("nbSquaresH");
        var nbRectHeight = rectHeightField.value;
        rectHeightField.addEventListener("input", generateMire);
        rectHeightField.addEventListener("keypress", squaresErgonomy);
        rectHeightField.addEventListener("blur", function currFunction() {
            if (rectHeightField.value <= 0) setSquaresFields(0)
        }); //Set the field to 0 if empty or not valid

        var squaresCheckbox = document.getElementById("squaresCheckbox");
        var rectAreSquares = squaresCheckbox.checked;
        squaresCheckbox.addEventListener("input", setRectAsSquares);

        var linesField = document.getElementById("linesField");
        var nLines = linesField.value;
        linesField.addEventListener("input", setLines);
        linesField.addEventListener("blur", function currFunction() {
            if (linesField.value <= 0) linesField.value = 0;
        }); //Set the field to 0 if empty or not valid

        var crossesCheckbox = document.getElementById("crossesCheckbox");
        var crossedLines = crossesCheckbox.checked;
        crossesCheckbox.addEventListener("input", setCrossedLines);

        var circlesField = document.getElementById("circlesField");
        var nCircles = circlesField.value;
        circlesField.addEventListener("input", setCircles);
        circlesField.addEventListener("blur", function currFunction() {
            if (circlesField.value <= 0) circlesField.value = 0;
        }); //Set the field to 0 if empty or not valid

        var fittedCirclesCheckbox = document.getElementById("fittedCirclesCheckbox");
        var fittedCircles = fittedCirclesCheckbox.checked;
        fittedCirclesCheckbox.addEventListener("input", setFittedCircles);
        
        //Gradient
        var grdStartColorSelector = document.getElementById("grdStartColorSelector");
        var grdStartColor = grdStartColorSelector.value;
        grdStartColorSelector.addEventListener("input", setGradientStartColor);
        
        var grdEndColorSelector = document.getElementById("grdEndColorSelector");
        var grdEndColor = grdEndColorSelector.value;
        grdEndColorSelector.addEventListener("input", setGradientEndColor);

        function myFunction(e) { //debug function
            rectAreSquares = squaresCheckbox.checked;
            alert(nLines);
        }

        //Canvas
        var canvas = document.getElementById("myCanvas");
        var canvasCtx = canvas.getContext("2d");
        var img = document.createElement("canvas");
        var imgCtx = img.getContext("2d");


        //Settings variables
        var rectWidth;
        var rectHeight;
        var fontSize;


        //Internal management
        var squaresEnabled = true;
        var bckSpaceCount = 0;
        var imgRatio;

        //Algorithm

        generateMire();

        //Setup the download button
        var link = document.getElementById("downloadButton");
        link.addEventListener('click', function(ev) {
            link.href = img.toDataURL();
            link.download = "mire_" + String(imgWidth) + "x" + String(imgHeight) + ".png";
        }, false);


        //Functions
        
        function setGradientStartColor() {
            grdStartColor = grdStartColorSelector.value;
            generateMire();
        }
        
        function setGradientEndColor() {
            grdEndColor = grdEndColorSelector.value;
            generateMire();
        }

        function setFittedCircles() {
            fittedCircles = fittedCirclesCheckbox.checked;
            generateMire();
        }

        function setCircles() {
            nCircles = circlesField.value;
            generateMire();
        }

        function setCrossedLines() {
            crossedLines = crossesCheckbox.checked;
            generateMire();
        }

        function setLines() {
            nLines = linesField.value;
            generateMire();
        }

        function squaresErgonomy(e) { //Squares fields ergonomy

            if (e.key == "Backspace") {
                bckSpaceCount++;
            } else {
                bckSpaceCount = 0;
            }

            if (bckSpaceCount == 3 && squaresEnabled && (nbRectWidth <= 0 || nbRectHeight <= 0)) {
                setSquaresFields(0);
                squaresEnabled = false;
            }
            if (nbRectWidth > 0 && nbRectHeight > 0) {
                squaresEnabled = true;
            }
            generateMire();
        }

        function setRectAsSquares() {
            rectAreSquares = squaresCheckbox.checked;
            rectHeightField.disabled = rectAreSquares;
            generateMire();
        }

        function setSquaresFields(n) {
            rectWidthField.value = 0;
            rectHeightField.value = 0;
        }



        function updateSettings() {
            imgWidth = widthField.value;
            imgHeight = heightField.value;
            img.width = imgWidth;
            img.height = imgHeight;

            nbRectWidth = rectWidthField.value;
            nbRectHeight = rectHeightField.value;
            rectWidth = imgWidth / nbRectWidth;
            rectHeight = imgHeight / nbRectHeight;
            fontSize = String(rectHeight > rectWidth ? rectWidth : rectHeight) + "px";

            imgCtx.font = fontSize + " Arial";
            imgCtx.textAlign = "center";
            imgCtx.textBaseline = "middle";

            imgRatio = imgWidth / imgHeight;
            canvas.height = canvas.width * 1 / imgRatio;
        }



        function generateMire() {
            updateSettings();
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawGradient();

            //Grid drawing
            for (var j = 0; j < nbRectWidth; ++j) {
                for (var i = 0; i < nbRectHeight; ++i) {
                    imgCtx.fillStyle = (i + j) % 2 == 0 ? "black" : "transparent";
                    if (rectAreSquares) {
                        imgCtx.fillRect(rectWidth * j, rectWidth * i, rectWidth, rectWidth);
                        imgCtx.fillStyle = (i + j) % 2 == 0 ? "blue" : "red";
                        imgCtx.fillText(1 + j, rectWidth / 2 + rectWidth * j, rectWidth / 2 + rectWidth * i);
                    } else {
                        imgCtx.fillRect(rectWidth * j, rectHeight * i, rectWidth, rectHeight);
                        imgCtx.fillStyle = (i + j) % 2 == 0 ? "blue" : "red";
                        imgCtx.fillText(1 + j, rectWidth / 2 + rectWidth * j, rectHeight / 2 + rectHeight * i);
                    }
                }
            }

            //Lines Drawing

            for (var i = 0; i < nLines; i++) {
                if (crossedLines) {
                    drawLine(imgWidth / nLines * i, 0, imgWidth / nLines * (i + 1), imgHeight);
                    drawLine(imgWidth / nLines * i, imgHeight, imgWidth / nLines * (i + 1), 0);
                } else
                    drawLine(imgWidth / nLines * i, 0, imgWidth / nLines * (i + 1), imgHeight);
            }

            //Circle drawing

            for (var i = 0; i < nCircles; i++) {
                if (fittedCircles) {
                    drawCircle(imgWidth / nCircles / 2 + imgWidth / nCircles * i, imgHeight / 2, imgWidth / nCircles / 2);
                } else
                    drawCircle(imgWidth / (nCircles * 2) + imgWidth / nCircles * i, imgHeight / 2, imgHeight / 2);

            }


            //Draw the working img in the page canvas
            canvasCtx.drawImage(img, 0, 0, img.width, img.height, // source rectangle
                0, 0, canvas.width, canvas.height); // destination rectangle
            //myFunction();
        }

        function drawGradient() {

            var grd = imgCtx.createLinearGradient(0, 0, imgWidth, 0);
            grd.addColorStop(0, grdStartColor);
            grd.addColorStop(1, grdEndColor);

            imgCtx.fillStyle = grd;
            imgCtx.fillRect(0, 0, imgWidth, imgHeight);
        }

        function drawCircle(x, y, r) {
            imgCtx.beginPath();
            imgCtx.arc(x, y, r, 0, 2 * Math.PI);
            imgCtx.lineWidth = 30;
            imgCtx.strokeStyle = "red";
            imgCtx.stroke();

        }

        function drawLine(x1, y1, x2, y2) {
            imgCtx.beginPath();
            imgCtx.moveTo(x1, y1);
            imgCtx.lineTo(x2, y2);
            imgCtx.lineWidth = 30;
            imgCtx.strokeStyle = "red";
            imgCtx.stroke();
        }

    </script>

</body>

</html>
