<!DOCTYPE html>
<html>

<body>

    <head>
        <title>Mirage Map</title>

        <style>
            body {
                background-color: #424242;
                font-family: "Arial";
            }

            canvas {
                display: inline-block;
                border: 1px solid #d3d3d3;
                position: fixed;
                right: 10px;
                top: 20px;
                width: 48%;
            }

            div {
                margin: 3px;
                position: relative;
                margin-bottom: 10px;
                /*outline: 2px dotted black;*/
            }

            input {
                width: 10%;
                background-color: #303030;
                color: lightsteelblue;
                border: solid 1px;
                border-radius: 15px;
            }

            input[type="color"] {
                background-color: transparent;
                border: none;
                vertical-align: middle;
                box-shadow: none;

            }

            input[type="checkbox"] {
                width: auto;
                margin-left: 20px;
            }

            input[type="text"] {
                padding: 3px;
                text-align: center;
                margin-left: 10px;
                margin-right: 10px;
            }

            input[type="text"]:disabled {
                background: #333333;
                color: dimgrey;
            }


            a {
                cursor: pointer;
            }

            p {
                display: inline;
                text-decoration: none;
                color: gainsboro;
                margin-top: 10px;
                margin-right: 0px;
                margin-left: 20px;
            }

            span {
                color: gainsboro;
            }

            h2 {
                color: #8d98aa;
                margin-top: 0px;
                margin-bottom: 15px;
            }


            .colorSelector {
                height: 34px;
                width: 50px;
                display: inline;
                border: none;
            }

            .Parametter {
                border-bottom: solid 2px #606060;
                padding-bottom: 2px;
            }

            #Settings {
                display: inline-block;
                background-color: transparent;
                width: 50%;
            }
            
            #mainTextField{
                width: 20%;
            }

            #ExportSettings {}

            #downloadButton {
                background-color: #4CAF50;
                /* Green */
                border: none;
                color: white;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: block;
                font-size: 16px;

            }

        </style>
    </head>

    <div id="Settings">
        <div class="Parametter" id="ImageSize">
            <div>
                <h2>Image</h2>
                <p>Size</p>
                <input type="text" id="imageWidthField" value="1920"> <span>x</span>
                <input type="text" id="imageHeightField" value="1080">
                <input style="display: none" type="checkbox" id="verticalCheckbox" checked="false" tabindex="-1">
                <span style="display: none">Vertical organization</span>
            </div>
        </div>
        <div class="Parametter" id="TextSettings">
            <div>
                <h2>Text</h2>
                <p>Main text</p>
                <input type="text" id="mainTextField" value="Title">
                <p>Weight</p>
                <input type="text" id="mainTextWeightField" value="300">
                <p>Color</p>
                <input class="colorSelector" type="color" id="textColorSelector" value="#ffff00" tabindex="-1">
            </div>
        </div>
        <div class="Parametter" id="GridSettings">
            <div>
                <h2>Grid</h2>
                <p>Size</p>
                <input type="text" id="nbSquaresW" value="10"> <span>x</span>
                <input type="text" id="nbSquaresH" value="10">


                <input type="checkbox" id="squaresCheckbox" checked="true" tabindex="-1" onclick="setRectAsSquares()">
                <span>Squares</span>
            </div>
            <div>

                <p>Checker</p>
                <input class="colorSelector" type="color" id="gridColorSelector" value="#000000" tabindex="-1">
                <p>Lines weight</p>
                <input type="text" id="gridLinesWeightField" value="10">
                <p>Lines</p>
                <input class="colorSelector" type="color" id="gridLinesColorSelector" value="#000000" tabindex="-1"></div>
            <div>
                <p>Numbers</p>
                <input class="colorSelector" type="color" id="numbersColorSelector" value="#ffffff" tabindex="-1">
            </div>
        </div>
        <div class="Parametter" id="LinesSettings">
            <div>
                <h2>Lines</h2>
                <p>How many</p>
                <input type="text" id="linesField" value="2">
                <p>Weight</p>
                <input type="text" id="linesWeightField" value="10">
                <input type="checkbox" id="crossesCheckbox" checked="true" tabindex="-1" onclick="setCrossedLines()">
                <span>Crosses</span>
            </div>
            <div>
                <input type="checkbox" id="middleCrossCheckbox" checked="true" tabindex="-1" onclick="setMiddleCross()">
                <span>Middle cross</span>
                <p>Lines</p>
                <input class="colorSelector" type="color" id="linesColorSelector" value="#ffffff" tabindex="-1">
            </div>
        </div>
        <div class="Parametter" id="CirclesSettings">
            <div>
                <h2>Circles</h2>
                <p>How many</p>
                <input type="text" id="circlesField" value="2">
                <p>Weight</p>
                <input type="text" id="circlesWeightField" value="10">
                <input type="checkbox" id="fittedCirclesCheckbox" checked="true" tabindex="-1" onclick="setFittedCircles()">
                <span>Fitted circles</span>
            </div>
            <div>
                <p>Circles</p>
                <input class="colorSelector" type="color" id="circlesColorSelector" value="#ffffff" tabindex="-1">
            </div>
        </div>
        <div class="Parametter" id="GradientSettings">
            <h2>Gradient</h2>
            <div>
                <p>Start</p>
                <input class="colorSelector" type="color" id="grdStartColorSelector" value="#ff0000" tabindex="-1">
                <p>End</p>
                <input class="colorSelector" type="color" id="grdEndColorSelector" value="#00ff00" tabindex="-1">
            </div>
        </div>
        <div id="ExportSettings">
            <a id="downloadButton">Download Image</a>
        </div>
    </div>

    <canvas id="myCanvas" width="720" height="405">
        Your browser does not support the canvas element.
    </canvas>



    <script>
        //Setup
        //Settings fields
        var widthField = document.getElementById("imageWidthField");
        var imgWidth = widthField.value;
        widthField.addEventListener("input", generateMire);

        var heightField = document.getElementById("imageHeightField");
        var imgHeight = widthField.value;
        heightField.addEventListener("input", generateMire);

        var verticalCheckbox = document.getElementById("verticalCheckbox");
        var verticalOrganization = verticalCheckbox.checked;
        verticalCheckbox.addEventListener("input", setVerticalOrganization);

        var mainTextField = document.getElementById("mainTextField");
        var mainText = mainTextField.value;
        mainTextField.addEventListener("input", setMainText);

        var mainTextWeightField = document.getElementById("mainTextWeightField");
        var maintTextWeight = mainTextWeightField.value;
        mainTextWeightField.addEventListener("input", setMainTextWeight);
        
        var textColorSelector = document.getElementById("textColorSelector");
        var textColor = textColorSelector.value;
        textColorSelector.addEventListener("input", setTextColor);

        var rectWidthField = document.getElementById("nbSquaresW");
        var nbRectWidth = rectWidthField.value;
        rectWidthField.addEventListener("input", generateMire);
        rectWidthField.addEventListener("keypress", gridUpdate);
        rectWidthField.addEventListener("input", gridUpdate); //Forcing height update
        rectWidthField.addEventListener("blur", function currFunction() {
            if (rectWidthField.value <= 0) setSquaresFields(0)
        }); //Set the field to 0 if empty or not valid

        var rectHeightField = document.getElementById("nbSquaresH");
        var nbRectHeight = rectHeightField.value;
        rectHeightField.addEventListener("input", generateMire);
        rectHeightField.addEventListener("keypress", gridUpdate);
        rectHeightField.addEventListener("blur", function currFunction() {
            if (rectHeightField.value <= 0) setSquaresFields(0)
        }); //Set the field to 0 if empty or not valid

        var squaresCheckbox = document.getElementById("squaresCheckbox");
        var rectAreSquares = squaresCheckbox.checked;
        squaresCheckbox.addEventListener("input", setRectAsSquares);

        var gridColorSelector = document.getElementById("gridColorSelector");
        var gridColor = gridColorSelector.value;
        gridColorSelector.addEventListener("input", setGridColor);

        var gridLinesWeightField = document.getElementById("gridLinesWeightField");
        var gridLinesWeight = gridLinesWeightField.value;
        gridLinesWeightField.addEventListener("input", setGridLinesWeight);
        gridLinesWeightField.addEventListener("blur", function currFunction() {
            if (gridLinesWeightField.value <= 0) gridLinesWeightField.value = 0;
        }); //Set the field to 0 if empty or not valid

        var gridLinesColorSelector = document.getElementById("gridLinesColorSelector");
        var gridLinesColor = gridLinesColorSelector.value;
        gridLinesColorSelector.addEventListener("input", setGridLinesColor);

        var numbersColorSelector = document.getElementById("numbersColorSelector");
        var numbersColor = numbersColorSelector.value;
        numbersColorSelector.addEventListener("input", setNumbersColor);

        var linesField = document.getElementById("linesField");
        var nLines = linesField.value;
        linesField.addEventListener("input", setLines);
        linesField.addEventListener("blur", function currFunction() {
            if (linesField.value <= 0) linesField.value = 0;
        }); //Set the field to 0 if empty or not valid

        var linesWeightField = document.getElementById("linesWeightField");
        var linesWeight = linesWeightField.value;
        linesWeightField.addEventListener("input", setLinesWeight);
        linesWeightField.addEventListener("blur", function currFunction() {
            if (linesWeightField.value <= 0) linesWeightField.value = 0;
        }); //Set the field to 0 if empty or not valid

        var linesColorSelector = document.getElementById("linesColorSelector");
        var linesColor = linesColorSelector.value;
        linesColorSelector.addEventListener("input", setLinesColor);

        var crossesCheckbox = document.getElementById("crossesCheckbox");
        var crossedLines = crossesCheckbox.checked;
        crossesCheckbox.addEventListener("input", setCrossedLines);

        var middleCrossCheckbox = document.getElementById("middleCrossCheckbox");
        var middlesCross = middleCrossCheckbox.checked;
        middleCrossCheckbox.addEventListener("input", setMiddleCross);

        var circlesField = document.getElementById("circlesField");
        var nCircles = circlesField.value;
        circlesField.addEventListener("input", setCircles);
        circlesField.addEventListener("blur", function currFunction() {
            if (circlesField.value <= 0) circlesField.value = 0;
        }); //Set the field to 0 if empty or not valid

        var circlesWeightField = document.getElementById("circlesWeightField");
        var circlesWeight = circlesWeightField.value;
        circlesWeightField.addEventListener("input", setCirclesWeight);
        circlesWeightField.addEventListener("blur", function currFunction() {
            if (linesField.value <= 0) circlesWeightField.value = 0;
        }); //Set the field to 0 if empty or not valid

        var circlesColorSelector = document.getElementById("circlesColorSelector");
        var circlesColor = circlesColorSelector.value;
        circlesColorSelector.addEventListener("input", setCirclesColor);

        var fittedCirclesCheckbox = document.getElementById("fittedCirclesCheckbox");
        var fittedCircles = fittedCirclesCheckbox.checked;
        fittedCirclesCheckbox.addEventListener("input", setFittedCircles);

        //Gradient
        var grdStartColorSelector = document.getElementById("grdStartColorSelector");
        var grdStartColor = grdStartColorSelector.value;
        grdStartColorSelector.addEventListener("input", setGradientStartColor);

        var grdEndColorSelector = document.getElementById("grdEndColorSelector");
        var grdEndColor = grdEndColorSelector.value;
        grdEndColorSelector.addEventListener("input", setGradientEndColor);

        function myFunction(e) { //debug function
            rectAreSquares = squaresCheckbox.checked;
            alert(nLines);
        }

        //Canvas
        var canvas = document.getElementById("myCanvas");
        var canvasCtx = canvas.getContext("2d");
        var img = document.createElement("canvas");
        var imgCtx = img.getContext("2d");


        //Settings variables
        var rectWidth;
        var rectHeight;
        var fontSize;


        //Internal management
        var squaresEnabled = true;
        var bckSpaceCount = 0;
        var imgRatio;

        //Algorithm
        setRectAsSquares();
        generateMire();

        //Setup the download button
        var link = document.getElementById("downloadButton");
        link.addEventListener('click', function(ev) {
            link.href = img.toDataURL();
            link.download = "mire_" + String(imgWidth) + "x" + String(imgHeight) + ".png";
        }, false);


        //Functions

        function setGradientStartColor() {
            grdStartColor = grdStartColorSelector.value;
            generateMire();
        }

        function setGradientEndColor() {
            grdEndColor = grdEndColorSelector.value;
            generateMire();
        }

        function setFittedCircles() {
            fittedCircles = fittedCirclesCheckbox.checked;
            generateMire();
        }

        function setCircles() {
            nCircles = circlesField.value;
            generateMire();
        }

        function setCirclesWeight() {
            circlesWeight = circlesWeightField.value;
            generateMire();
        }

        function setCirclesColor() {
            circlesColor = circlesColorSelector.value;
            generateMire();
        }

        function setCrossedLines() {
            crossedLines = crossesCheckbox.checked;
            generateMire();
        }

        function setMiddleCross() {
            middlesCross = middleCrossCheckbox.checked;
            generateMire();
        }

        function setLines() {
            nLines = linesField.value;
            generateMire();
        }

        function setLinesWeight() {
            linesWeight = linesWeightField.value;
            generateMire();
        }

        function setLinesColor() {
            linesColor = linesColorSelector.value;
            generateMire();
        }

        function setGridLinesWeight() {
            gridLinesWeight = gridLinesWeightField.value;
            generateMire();
        }

        function setGridColor() {
            gridColor = gridColorSelector.value;
            generateMire();
        }

        function setGridLinesColor() {
            gridLinesColor = gridLinesColorSelector.value;
            generateMire();
        }

        function setMainText() {
            mainText = mainTextField.value;
            generateMire();
        }

        function setMainTextWeight() {
            mainTextWeight = mainTextWeightField.value;
            generateMire();
        }
        
        function setTextColor() {
            textColor = textColorSelector.value;
            generateMire();
        }

        function setNumbersColor() {
            numbersColor = numbersColorSelector.value;
            generateMire();
        }

        function gridUpdate(e) { //Squares fields ergonomy

            if (e.key == "Backspace") {
                bckSpaceCount++;
            } else {
                bckSpaceCount = 0;
            }

            if (bckSpaceCount == 3 && squaresEnabled && (nbRectWidth <= 0 || nbRectHeight <= 0)) {
                setSquaresFields(0);
                squaresEnabled = false;
            }
            if (nbRectWidth > 0 && nbRectHeight > 0) {
                squaresEnabled = true;
            }



            if (rectAreSquares)
                rectHeightField.value = rectWidthField.value;
            generateMire();

        }

        function setRectAsSquares() {
            rectAreSquares = squaresCheckbox.checked;
            rectHeightField.disabled = rectAreSquares;
            rectHeightField.value = rectWidthField.value;
            generateMire();
        }

        function setSquaresFields(n) {
            rectWidthField.value = 0;
            rectHeightField.value = 0;
        }

        function setVerticalOrganization() {
            verticalOrganization = verticalCheckbox.checked;
            generateMire();
        }



        function updateSettings() {
            imgWidth = widthField.value;
            imgHeight = heightField.value;
            img.width = imgWidth;
            img.height = imgHeight;

            nbRectWidth = rectWidthField.value;
            nbRectHeight = rectHeightField.value;
            rectWidth = imgWidth / nbRectWidth;
            rectHeight = imgHeight / nbRectHeight;
            fontSize = String(rectHeight > rectWidth ? rectWidth : rectHeight) + "px";
            
            mainTextWeight = mainTextWeightField.value;

            imgCtx.font = fontSize + " Arial";
            imgCtx.textAlign = "center";
            imgCtx.textBaseline = "middle";

            imgRatio = imgWidth / imgHeight;
            canvas.height = canvas.width * 1 / imgRatio;

            safeValues();
        }

        function safeValues() {
            //Secures the quantity of the squares
            if (nbRectHeight >= imgHeight / 8) {
                nbRectHeight = imgHeight / 8;
                rectHeightField.value = nbRectHeight;
            }
            if (nbRectWidth >= imgWidth / 8) {
                nbRectWidth = imgWidth / 8;
                rectWidthField.value = nbRectWidth;
            }
        }


        function generateMire() {
            updateSettings();
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

            drawGradient();


            //Grid drawing (checker)
            for (var j = 0; j < nbRectWidth; ++j) {
                for (var i = 0; i < nbRectHeight; ++i) {
                    imgCtx.globalAlpha = 0.4;
                    imgCtx.fillStyle = (i + j) % 2 == 0 ? gridColor : "transparent";
                    if (rectAreSquares) {
                        imgCtx.fillRect(rectWidth * j, rectWidth * i, rectWidth, rectWidth);
                    } else {
                        imgCtx.fillRect(rectWidth * j, rectHeight * i, rectWidth, rectHeight);
                    }
                    imgCtx.globalAlpha = 1;
                }
            }

            //Grid drawing (lines)
            for (var j = 0; j < nbRectWidth; ++j) {
                for (var i = 0; i < nbRectHeight; ++i) {
                    imgCtx.lineWidth = gridLinesWeight;
                    imgCtx.strokeStyle = gridLinesColor;
                    if (rectAreSquares) {
                        imgCtx.strokeRect(rectWidth * j, rectWidth * i, rectWidth, rectWidth);
                    } else {
                        imgCtx.strokeRect(rectWidth * j, rectHeight * i, rectWidth, rectHeight);
                    }
                }
            }

            //Text drawing
            for (var j = 0; j < nbRectWidth; ++j) {
                for (var i = 0; i < nbRectHeight; ++i) {
                    if (rectAreSquares) {
                        //imgCtx.fillStyle = (i + j) % 2 == 0 ? "blue" : "red";
                        imgCtx.fillStyle = numbersColor;
                        imgCtx.fillText(1 + j, rectWidth / 2 + rectWidth * j, rectWidth / 2 + rectWidth * i);
                    } else {
                        //imgCtx.fillStyle = (i + j) % 2 == 0 ? "blue" : "red";
                        imgCtx.fillStyle = numbersColor;
                        imgCtx.fillText(1 + j, rectWidth / 2 + rectWidth * j, rectHeight / 2 + rectHeight * i);
                    }
                }
            }

            //Lines Drawing

            for (var i = 0; i < nLines; i++) {
                if (crossedLines) {
                    drawLine(imgWidth / nLines * i, 0, imgWidth / nLines * (i + 1), imgHeight);
                    drawLine(imgWidth / nLines * i, imgHeight, imgWidth / nLines * (i + 1), 0);
                } else
                    drawLine(imgWidth / nLines * i, 0, imgWidth / nLines * (i + 1), imgHeight);
            }

            //Middles cross Lines
            if (middlesCross) {
                drawLine(imgWidth / 2, 0, imgWidth / 2, imgHeight);
                drawLine(0, imgHeight / 2, imgWidth, imgHeight / 2);
            }

            //Circle drawing

            for (var i = 0; i < nCircles; i++) {
                if (fittedCircles) {
                    drawCircle(imgWidth / nCircles / 2 + imgWidth / nCircles * i, imgHeight / 2, imgWidth / nCircles / 2);
                } else
                    drawCircle(imgWidth / (nCircles * 2) + imgWidth / nCircles * i, imgHeight / 2, imgHeight / 2);

            }

            //Text displaying
            imgCtx.fillStyle = textColor;
            imgCtx.font = String(mainTextWeight) +"px"+" Arial";
            imgCtx.fillText(mainText, imgWidth / 2, imgHeight/2);


            //Draw the working img in the page canvas
            canvasCtx.drawImage(img, 0, 0, img.width, img.height, // source rectangle
                0, 0, canvas.width, canvas.height); // destination rectangle
            //myFunction();
        }

        function drawGradient() {

            var grd = imgCtx.createLinearGradient(0, 0, imgWidth, 0);
            grd.addColorStop(0, grdStartColor);
            grd.addColorStop(1, grdEndColor);

            imgCtx.fillStyle = grd;
            imgCtx.fillRect(0, 0, imgWidth, imgHeight);
        }

        function drawCircle(x, y, r) {
            imgCtx.beginPath();
            imgCtx.arc(x, y, r, 0, 2 * Math.PI);
            imgCtx.lineWidth = circlesWeight;
            imgCtx.strokeStyle = circlesColor;
            imgCtx.stroke();

        }

        function drawLine(x1, y1, x2, y2) {
            imgCtx.beginPath();
            imgCtx.moveTo(x1, y1);
            imgCtx.lineTo(x2, y2);
            imgCtx.lineWidth = linesWeight;
            imgCtx.strokeStyle = linesColor;
            imgCtx.stroke();
        }

    </script>

</body>

</html>
